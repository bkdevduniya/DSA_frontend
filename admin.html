<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSA Question Recommender - Admin</title>
    <link rel="stylesheet" href="./admin.css">
</head>
<body>
    <!-- Loading overlay that will be shown while checking auth status -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p>Verifying admin privileges...</p>
    </div>
    
    <!-- Error message container (hidden by default) -->
    <div class="error-message" id="errorMessage">
        <h2>Access Denied</h2>
        <p id="errorText">You don't have permission to access this page.</p>
        <a href="/login.html" style="color: #3498db;">Return to login page</a>
    </div>
    
    <div id="pageContent" style="display: none;">
    <nav class="navbar">
        <div class="navbar-title">DSA Question Recommender</div>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/problemset">Questions</a>
            <a href="#" class="active">Add New</a>
            <a href="/users">Users</a>
            <a href="#" id="logoutLink">Logout</a>
        </div>
    </nav>

    <div id="questionsubmitResponse">

    </div>

    <div class="container">
        <h1 class="form-header">Add New Question</h1>
        
        <form class="question-form" id="questionForm" action="http://localhost:5000/api/questions" method="post">
            <div class="form-grid">
                <div class="form-group">
                    <label for="questionTitle" class="form-label">Question Title:</label>
                    <input type="text" id="questionTitle" class="form-control" name="title" required>
                </div>
                
                <div class="form-group">
                    <label for="platform" class="form-label">Platform:</label>
                    <select id="platform" class="form-control" name="platform" required>
                        <option value="">Select Platform</option>
                        <option value="leetcode">LeetCode</option>
                        <option value="hackerrank">HackerRank</option>
                        <option value="codeforces">Codeforces</option>
                        <option value="codechef">CodeChef</option>
                        <option value="geeksforgeeks">GeeksforGeeks</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="problemUrl" class="form-label">Problem URL:</label>
                    <input type="url" id="problemUrl" class="form-control" name="problemUrl" required>
                </div>
                
                <div class="form-group">
                    <label for="difficulty" class="form-label">Difficulty:</label>
                    <select id="difficulty" class="form-control" name="difficulty" required>
                        <option value="">Select Difficulty</option>
                        <option value="easy">Easy</option>
                        <option value="medium">Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="rating" class="form-label">Rating :</label>
                    <input type="number" id="rating" class="form-control rating-input" name="rating" required>
                </div>
                
                <div class="form-group">
                    <label for="tags" class="form-label">Tag (select the most relevant):</label>
                    <select id="tags" class="form-control form-select-single" name="tags" required>
                        <option value="array">Array</option>
                        <option value="string">String</option>
                        <option value="linked list">Linked List</option>
                        <option value="hash table">Hash Table</option>
                        <option value="two pointers">Two Pointers</option>
                        <option value="sorting">Sorting</option>
                        <option value="searching">Searching</option>
                        <option value="recursion">Recursion</option>
                        <option value="binary search">Binary Search</option>
                        <option value="sliding window">Sliding Window</option>
                        <option value="heap">Heap</option>
                        <option value="tree">Tree</option>
                        <option value="backtracking">Backtracking</option>
                        <option value="greedy">Greedy</option>
                        <option value="dfs">Depth-First Search (DFS)</option>
                        <option value="bfs">Breadth-First Search (BFS)</option>
                        <option value="bit manipulation">Bit Manipulation</option>
                        <option value="prefix sum">Prefix Sum</option>
                        <option value="graph">Graph</option>
                        <option value="topological sort">Topological Sort</option>
                        <option value="dp">Dynamic Programming (DP)</option>
                        <option value="trie">Trie</option>
                        <option value="segment tree">Segment Tree</option>
                        <option value="fenwick tree">Fenwick Tree</option>
                        <option value="persistent segment-tree">Persistent Segment Tree</option>
                        <option value="sparse table">Sparse Table</option>
                        <option value="number theory">Number Theory</option>
                        <option value="combinatorics">Combinatorics</option>
                        <option value="modular arithmetic">Modular Arithmetic</option>
                        <option value="game theory">Game Theory</option>
                        <option value="bitmasking">Bitmasking</option>
                        <option value="memoization">Memoization</option>
                        <option value="geometry">Geometry</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="companies" class="form-label">Companies (can be multiple):</label>
                    <select id="companies" class="form-control form-select-multiple" multiple name="companies">
                        <option value="google">Google</option>
                        <option value="amazon">Amazon</option>
                        <option value="microsoft">Microsoft</option>
                        <option value="meta">Meta</option>
                        <option value="apple">Apple</option>
                        <option value="netflix">Netflix</option>
                        <option value="uber">Uber</option>
                        <option value="airbnb">Airbnb</option>
                        <option value="oracle">Oracle</option>
                        <option value="twitter">Twitter</option>
                    </select>
                </div>
                
                <!-- <div class="form-group">
                    <label class="form-label">Solution File (Optional):</label>
                    <div class="file-upload-wrapper">
                        <button type="button" class="file-upload-button">Choose File</button>
                        <input type="file" id="solutionFile" class="file-upload-input">
                        <span class="file-upload-name" id="fileName">No file chosen</span>
                    </div>
                </div> -->
            </div>
            
            <div class="form-actions">
                <!-- <button type="button" class="btn btn-draft" id="saveDraftBtn">Save as Draft</button> -->
                <button type="submit" class="btn btn-publish" id="publishBtn">Publish Question</button>
            </div>
        </form>
    </div>
    
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check admin status immediately when page loads
    checkAdminStatus();
    
    // Set up logout link
    document.getElementById('logoutLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        


        logoutUser();
    });
});
document.getElementById("questionForm").addEventListener("submit", async function(event) {
    event.preventDefault(); // Prevent form submission
   
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    try{
   const response = await fetch("http://localhost:5000/api/addQuestion", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: "include", // Include cookies for session
        body: JSON.stringify(data)
    });
    const result = await response.json();
    console.log(result.msg);
    if (result.msg == "question uploaded") {
        let x=document.getElementById("questionsubmitResponse");
        x.textContent = result.msg;
        x.style.display = 'inline-block';
        x.style.color = 'green';
        x.style.fontWeight = 'bold';
        x.style.border = 'solid 1px green';
        x.style.boxShadow = '3px 3px 3px green, -3px -3px 3px green';
    }
    else{
        let x=document.getElementById("questionsubmitResponse");
        x.textContent = result.msg;
        x.style.display = 'inline-block';
        x.style.color = 'red';
        x.style.fontWeight = 'bold';
        x.style.border = 'solid 1px red';
        x.style.boxShadow = '3px 3px 3px red, -3px -3px 3px red';
    }
   
}
catch(err){
    console.log(err);
    let x=document.getElementById("questionsubmitResponse");
        x.textContent = err;
        x.style.display = 'inline-block';
        x.style.color = 'red';
        x.style.fontWeight = 'bold';
        x.style.border = 'solid 1px red';
        x.style.boxShadow = '3px 3px 3px red, -3px -3px 3px red';
}
window.scrollTo(0, 0);
})
async function checkAdminStatus() {
    try {
        const response = await fetch('http://localhost:5000/api/admin', {
            method: 'GET',
            credentials: 'include', // Include cookies for session
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        });

        const data = await response.json();
        
        if (response.ok && data.admin) {
            // User is admin, show the page content
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('pageContent').style.display = 'block';
        } else {
            // User is not admin or not logged in
            showError(data.msg || 'You need admin privileges to access this page.');
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    } catch (error) {
        console.error('Error checking admin status:', error);
        showError('Failed to verify admin status. Please try again later.');
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

function showError(message) {
    const errorElement = document.getElementById('errorMessage');
    document.getElementById('errorText').textContent = message;
    errorElement.style.display = 'block';
}

async function logoutUser() {
    try {
        const response = await fetch('http://localhost:5000/api/logout', {
            method: 'POST',
            credentials: 'include'
        });
        if (response.ok) {
            window.location.reload();
            window.location.href = '/login.html';
        } else {
            alert('Logout failed. Please try again.');
        }
    } catch (error) {
        console.error('Logout error:', error);
        alert('Logout failed. Please try again.');
    }
}
    </script>
</body>
</html>
